'use strict';

// document.getElementById("capt1").addEventListener("click", function() { alert(1) }, true);
// document.getElementById("capt2").addEventListener("click", function() { alert(2) }, true);
// document.getElementById("capt3").addEventListener("click", function() { alert(3) }, true);
// document.getElementById("capt1").addEventListener("click", function() { alert(1) }, false);
// document.getElementById("capt2").addEventListener("click", function() { alert(2) }, false);
// document.getElementByI d("capt3").addEventListener("click", function() { alert(3) }, false);

var i = 0;
var temp = function temp(e) {
    e = e || event;
    var target = e.target || e.srcElement;

    var companyText = document.getElementsByName(target.id);
    var companyText1 = document.getElementsByName(this.id);
    var temp1 = parseFloat(companyText[1].innerHTML, 10);
    temp1 = isNaN(temp1) ? 0 : temp1;
    var temp2 = isNaN(parseFloat(companyText[2].innerHTML, 10)) ? 0 : parseFloat(companyText[2].innerHTML, 10);
    var temp3 = temp2 + temp1;
    companyText[2].innerHTML = temp3;
};

window.onload = function LoadFromDb() {
    $.ajax({
        type: 'POST',
        url: '/get/companies',
        contentType: 'application/json',
        success: function(data) {
            for (var i = 0; i < data.length; ++i) {
                var obj = JSON.parse(data[i]);
                CreateCompany(obj.id, obj.name, obj.companyPrice, obj.parentId);
            }
        }
    });
};

var DeleteCompany = function DeleteCompany(id) {
    var deleteCompany = document.getElementById(id);
    $.ajax({
        type: 'POST',
        url: '/delete/company',
        data: JSON.stringify({'id' : id}),
        contentType: 'application/json',
        success: function() {
            var deleteCompany = document.getElementById(id); 
            deleteCompany.parentNode.removeChild(deleteCompany);
        }       
    });
};

var DeleteAll = function DeleteAll() {
    $.ajax({
        type: 'POST',
        url: '/delete/companies',
        contentType: 'application/json',
        success: function() {
            var delElem = document.getElementById("AddCompanyDiv");
            while(delElem.firstChild) {
                delElem.removeChild(delElem.firstChild);
            }
        }
    });
};

var AddCompany = function AddCompany(id, addOrEdit) {
    var companyName = document.getElementById("name").value;
    var price = parseFloat(document.getElementById("price").value, 10);

    document.getElementById("price").style.borderColor = isNaN(price) ? "red" : "green";
    document.getElementById("name").style.borderColor = companyName == "" ? "red" : "green";

    if (isNaN(price) || companyName == "") return;

    DeleteInputForm();
    var addOrEditBool = addOrEdit === undefined;

    $.ajax({
        type: 'POST',
        contentType: 'application/json; charset=windows-1251',
        url: addOrEditBool ? '/add/company' : '/edit/company',
        data: JSON.stringify({'parentId' : id, 'name' : companyName, 'companyPrice' : price}),
        success: function(data) {
            addOrEditBool ?
            CreateCompany(data.id, companyName, price, id) :
            EditCompany(id, companyName, price);
        }
    });
};

var EditCompany = function EditCompany(id, companyName, price) {
    var companyText = document.getElementsByName(id);
    companyText[0].innerHTML = companyName;
    companyText[1].innerHTML = price;
};

var DeleteInputForm = function DeleteInputForm() {
    var inputForm = document.getElementById("ImputForm");
    inputForm.parentNode.removeChild(inputForm);;
};

var CreateInputForm = function CreateInputForm(id, addOrEdit) {
    var inputForm = document.getElementById("ImputForm");
    if (inputForm) return;

    var element = document.createElement('form');
    element.setAttribute("id", "ImputForm");
    element.setAttribute("class", "form-inline");
    element.setAttribute("role", 'form');

    if (id == -1) {
        var mainDiv = document.getElementById("AddCompanyDiv");
        mainDiv.appendChild(element);
    } else {
        var mainCompany = document.getElementById("nodes-" + id);
        mainCompany.appendChild(element);
    }

    var div = document.createElement('div');
    div.setAttribute("class", "form-group");
    element.appendChild(div);

    var node1 = document.createElement('label');
    node1.setAttribute("for", "name");
    node1.innerHTML = "Company name";
    div.appendChild(node1);

    var node2 = document.createElement('input');
    node2.setAttribute("id", "name");
    node2.setAttribute("type", "text");
    node2.setAttribute("class", "form-control");
    node2.setAttribute("placeholder", "name");
    div.appendChild(node2);

    var node3 = document.createElement('label');
    node3.setAttribute("for", "price");
    node3.innerHTML = "Price";
    div.appendChild(node3);

    var node4 = document.createElement('input');
    node4.setAttribute("id", "price");
    node4.setAttribute("type", "text");
    node4.setAttribute("class", "form-control");
    node4.setAttribute("placeholder", "money");
    div.appendChild(node4);

    var node5 = document.createElement('input');
    node5.setAttribute("value", "Submit");
    node5.setAttribute("type", "submit");
    node5.setAttribute("id", id);
    node5.setAttribute("class", "btn btn-success");
    var nodeOnclickAttribute = addOrEdit === undefined ? "this.id" : "this.id, \"edit\"";
    node5.setAttribute("onclick", "AddCompany(" + nodeOnclickAttribute + ")");
    div.appendChild(node5);

    var node6 = document.createElement('input');
    node6.setAttribute("value", "Cancel");
    node6.setAttribute("type", "cancel");
    node6.setAttribute("class", "btn btn-danger");
    node6.setAttribute("onclick", "DeleteInputForm()");
    div.appendChild(node6);
};

var CreateCompany = function CreateCompany(id, name, price, parentId) {
    var element = document.createElement('div');
    element.setAttribute("id", id);
    element.setAttribute("class", "company");
    element.setAttribute("onchange", "temp(e)");

    if (parentId == -1) {
        var mainDiv = document.getElementById("AddCompanyDiv");
        mainDiv.appendChild(element);
    } else {
        var parentCompany = document.getElementById("nodes-" + parentId);
        parentCompany.appendChild(element);
    }

    var span1 = document.createElement('span');
    span1.setAttribute("class", "companyText");
    element.appendChild(span1);

    var b1 = document.createElement('b');
    b1.setAttribute("id", id);
    b1.setAttribute("name", id);
    b1.setAttribute("class", "name");
    b1.innerHTML = name;
    span1.appendChild(b1);

    var b2 = document.createElement('b');
    b2.setAttribute("id", id);
    b2.setAttribute("name", id);
    b2.setAttribute("class", "price");
    b2.innerHTML = price;
    span1.appendChild(b2);

    var b3 = document.createElement('b');
    b3.setAttribute("id", id);
    b3.setAttribute("name", id);
    b3.setAttribute("class", "name");
    //b3.innerHTML = price;
    span1.appendChild(b3);

    var span2 = document.createElement('span');
    span2.setAttribute("class", "companyButtons");
    element.appendChild(span2);

    var divWithNodes = document.createElement('div');
    divWithNodes.setAttribute("class", "nodes");
    divWithNodes.setAttribute("id", "nodes-" + id);
    element.appendChild(divWithNodes);

    var button1 = document.createElement('button');
    button1.setAttribute("type", "button");
    button1.setAttribute("id", id);
    button1.setAttribute("class", "btn btn-default btn-xs");
    button1.setAttribute("aria-label", "Right Align");
    button1.setAttribute("onclick", "CreateInputForm(this.id, \"edit\")");
    span2.appendChild(button1);
    var glyphicon1 = document.createElement('span');
    glyphicon1.setAttribute("class", "glyphicon glyphicon-pencil");
    glyphicon1.setAttribute("aria-hidden", "true");
    button1.appendChild(glyphicon1);

    var button2 = document.createElement('button');
    button2.setAttribute("type", "button");
    button2.setAttribute("id", id);
    button2.setAttribute("class", "btn btn-default btn-xs");
    button2.setAttribute("onclick", "CreateInputForm(this.id)");
    span2.appendChild(button2);
    var glyphicon2 = document.createElement('span');
    glyphicon2.setAttribute("class", "glyphicon glyphicon-plus");
    glyphicon2.setAttribute("aria-hidden", "true");
    button2.appendChild(glyphicon2);

    var button3 = document.createElement('button');
    button3.setAttribute("type", "button");
    button3.setAttribute("id", id);
    button3.setAttribute("class", "btn btn-default btn-xs");
    button3.setAttribute("onclick", "DeleteCompany(this.id)");
    span2.appendChild(button3);
    var glyphicon3 = document.createElement('span');
    glyphicon3.setAttribute("class", "lyphicon glyphicon-minus");
    glyphicon3.setAttribute("aria-hidden", "true");
    button3.appendChild(glyphicon3);
};